# Ongeul (온글)

macOS용 한글 입력기 — 하나의 입력 소스로 한글과 영문을 모두 처리합니다.

<p align="center">
  <img src="design/ongeul-app-icon.svg" alt="Ongeul App Icon" width="128">
</p>

## 왜 Ongeul인가?

macOS 기본 한글 입력기는 한/영 전환 시 **입력 소스를 전환**합니다. 이 과정에서 InputMethodKit의 세션 간섭 버그로 인해 글자가 씹히거나 지연이 발생할 수 있습니다.

Ongeul은 **단일 입력 소스** 안에서 한글과 영문을 모두 처리하여 이 문제를 근본적으로 해결합니다.

|                  | 기존 입력기              | Ongeul           |
| ---------------- | ------------------------ | ---------------- |
| 영문 입력        | 시스템에 위임 (ABC 전환) | 엔진이 직접 입력 |
| 등록된 입력 소스 | 2개 (한글 + ABC)         | 1개 (Ongeul만)   |
| 한/영 전환       | macOS 입력 소스 전환     | 내부 모드 전환   |
| 세션 간섭        | 발생 가능                | 원천 차단        |

## 주요 기능

### 키보드 레이아웃

세 가지 한글 키보드 레이아웃을 지원합니다.

- **두벌식 표준** — 가장 널리 사용되는 한글 키보드 배열
- **세벌식 390** — 세벌식 자판 (숫자열 리매핑 포함)
- **세벌식 최종** — 세벌식 최종 자판 (특수 기호, 인용부호 포함)

레이아웃은 JSON5 형식으로 정의되어 편집과 확장이 쉽습니다.

### 한/영 전환

두 가지 전환 방식을 설정에서 선택할 수 있습니다.

- **오른쪽 Command** (기본값) — 누른 뒤 떼면 전환, 다른 키와 함께 누르면 무시
- **Shift + Space** — 전통적인 한/영 전환 방식

### 모드 인디케이터

한/영 전환 시 커서 근처에 현재 모드를 표시합니다.

- 한글 모드: 강조 색상 배경에 **한** 표시
- 영문 모드: **A** 표시
- 1.6초 후 자동으로 사라짐

### 앱별 입력 모드 기억

앱마다 마지막 입력 모드를 기억합니다. 브라우저에서 한글을 쓰다가 터미널로 전환하면, 각 앱에서 마지막으로 사용한 모드가 복원됩니다.

### CapsLock 정규화

한글 모드에서 CapsLock이 켜져 있어도 정상적으로 한글이 입력됩니다. 영문 모드에서는 기존 대문자 동작이 유지됩니다.

### 한글 조합 오토마타

- **두벌식**: 6단계 상태 머신 (초성→중성→중성2→종성→종성2)
- **세벌식**: 위치별 자모를 사용한 오토마타
- 겹모음/겹종성 자동 조합 (ㅗ+ㅏ=ㅘ, ㄱ+ㅅ=ㄳ 등)
- 종성 분리: 종성 뒤에 모음이 오면 자동 분리 (간+ㅕ → 가+녀)
- 백스페이스로 조합 단계별 취소

## 아키텍처

Rust 엔진 + Swift 프론트엔드 하이브리드 구조. [UniFFI](https://mozilla.github.io/uniffi-rs/)를 통한 FFI 바인딩으로 연결됩니다.

```
┌─────────────────────────────────┐
│  OngeulApp (Swift)              │
│  macOS InputMethodKit 연동      │
│  모드 인디케이터, 설정 UI        │
└──────────┬──────────────────────┘
           │ UniFFI (FFI)
┌──────────▼──────────────────────┐
│  rshangul (Rust)                │
│  한글 조합 오토마타              │
│  자모 합성/분해, 유니코드 처리   │
│  키보드 레이아웃 파서            │
└─────────────────────────────────┘
```

- **rshangul** (Rust): 한글 조합의 모든 로직을 담당. Swift 쪽에는 한글 처리 로직이 전혀 없음.
- **OngeulApp** (Swift): 키 이벤트 수신 → Rust 엔진에 위임 → 결과 적용의 얇은 셸 역할.

## 설치

### 요구사항

- macOS 14.0 (Sonoma) 이상
- Rust toolchain (`aarch64-apple-darwin`)
- Xcode / Swift toolchain

### 빌드 및 설치

```bash
# 빌드만
./scripts/build.sh

# 빌드 + ~/Library/Input Methods에 설치
./scripts/install.sh
```

### 설치 후 설정

1. **로그아웃/로그인** (최초 설치 시 필요)
2. 시스템 설정 → 키보드 → 입력 소스 → 편집 → + → **Ongeul** 추가
3. 기존 입력 소스 (ABC 등) 제거 — Ongeul이 영문도 처리합니다
4. 시스템 설정에서 "Caps Lock으로 ABC 입력 소스로 전환" 옵션 비활성화

## 설정

메뉴 막대의 Ongeul 아이콘 → **설정(Preference)** 에서 다음을 변경할 수 있습니다.

- **전환 키**: 오른쪽 Command / Shift + Space
- **키보드 레이아웃**: 두벌식 표준 / 세벌식 390 / 세벌식 최종

## 테스트

```bash
cargo test -p rshangul
```

유니코드 처리, 두벌식/세벌식 오토마타, 레이아웃 파서, 통합 테스트를 포함한 91개 이상의 테스트가 있습니다.

## 디버그 로그

```bash
log stream --predicate 'subsystem == "io.github.hiking90.inputmethod.Ongeul"'
```

## 라이선스

[Apache License 2.0](LICENSE)
